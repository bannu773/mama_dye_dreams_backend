service: mama-dye-dreams-backend

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, 'ap-south-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 2048
  timeout: 120
  
  # Configure API Gateway to handle binary media types (images)
  apiGateway:
    binaryMediaTypes:
      - 'multipart/form-data'
      - 'image/*'
      - '*/*'
    shouldStartNameWithService: true
  
  environment:
    NODE_ENV: ${self:provider.stage}
    MONGODB_URI: ${env:MONGODB_URI}
    SESSION_SECRET: ${env:SESSION_SECRET}
    CORS_ORIGIN: ${env:CORS_ORIGIN}
    AWS_ACCESS_KEY_ID: ${env:AWS_ACCESS_KEY_ID}
    AWS_SECRET_ACCESS_KEY: ${env:AWS_SECRET_ACCESS_KEY}
    AWS_REGION: ${env:AWS_REGION}
    AWS_S3_BUCKET_NAME: ${env:AWS_S3_BUCKET_NAME}
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID}
    RAZORPAY_KEY_ID: ${env:RAZORPAY_KEY_ID}
    RAZORPAY_KEY_SECRET: ${env:RAZORPAY_KEY_SECRET}

  # IAM role permissions
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - "arn:aws:s3:::${env:AWS_S3_BUCKET_NAME}"
            - "arn:aws:s3:::${env:AWS_S3_BUCKET_NAME}/*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "arn:aws:logs:${self:provider.region}:*:*"

functions:
  api:
    handler: dist/handler.main
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors: true
      - http:
          path: /
          method: ANY
          cors: true

package:
  individually: false
  exclude:
    - .git/**
    - .gitignore
    - README.md
    - .env
    - .env.example
    - .serverlessignore
    - node_modules/.bin/**
    - '**/*.md'
    - coverage/**
    - .nyc_output/**
    - src/** 
    - tsconfig.json
  include:
    - dist/**
    - node_modules/**

plugins:
  - serverless-offline
  # - serverless-dynamodb-local # Not using DynamoDB

custom:
  serverless-offline:
    httpPort: 3001
    websocketPort: 3002
